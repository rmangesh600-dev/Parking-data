<!DOCTYPE html>
<html lang="mr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>रेल्वे स्टेशन पार्किंग (Updated)</title>
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
<style>
:root{--bg:#061126;--panel:#0b1b2e;--text:#e6eef8;--muted:#89a0bb;--brand:#ffd54f;--accent:#4fc3f7}
*{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; background:var(--bg);color:var(--text);}
.wrap{max-width:980px;margin:0 auto;padding:18px}
nav{display:flex;justify-content:space-between;align-items:center;padding:12px 0}
.logo{font-weight:800}
.card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,.04)}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:760px){.row{grid-template-columns:1fr}}
input,select,button{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.06);background:transparent;color:var(--text)}
.btn{cursor:pointer}
.qr{display:grid;place-items:center;border:1px dashed rgba(255,255,255,.06);padding:12px;border-radius:10px}
.small{font-size:13px;color:var(--muted)}
.footer{margin-top:18px;text-align:center;color:var(--muted)}
</style>
</head>
<body>
<nav class="wrap"><div class="logo">रेल्वे स्टेशन पार्किंग</div><div><a href="/admin.html" style="color:var(--brand)">Admin Dashboard</a></div></nav>
<main class="wrap">
  <section class="card">
    <h2>१) वाहन एंट्री</h2>
    <form id="entryForm" onsubmit="event.preventDefault(); startEntry();">
      <div class="row">
        <input id="vehicleNo" placeholder="वाहन क्रमांक (उदा. MH12AB1234)" required/>
        <input id="mobile" placeholder="मोबाईल (10 अंक)" pattern="\d{10}" required/>
      </div>
      <div class="row" style="margin-top:8px">
        <select id="duration" required>
          <option value="">पार्किंग कालावधी निवडा</option>
          <option value="1">1 तास</option>
          <option value="2">2 तास</option>
          <option value="6">6 तास</option>
          <option value="24">पूर्ण दिवस</option>
        </select>
        <label class="small"><input type="checkbox" id="seasonPass"/> नेहमी येणारा ग्राहक (सीझन पास)</label>
      </div>
      <div style="margin-top:10px">
        <button class="btn" type="submit">पुढे</button>
      </div>
    </form>
  </section>

  <section class="card" id="paymentCard" style="display:none;margin-top:12px">
    <h2>२) पेमेंट</h2>
    <div class="row">
      <select id="vehicleType" onchange="calc()" >
        <option value="">वाहन प्रकार</option>
        <option value="2w">दुचाकी</option>
        <option value="4w">चारचाकी</option>
      </select>
      <input id="amount" readonly placeholder="रक्कम"/>
    </div>
    <div style="margin-top:10px" class="qr" id="qrcode">QR येथं दिसेल</div>
    <div style="margin-top:8px" class="small">UPI ID: <b>7558459483@ptsbi</b></div>
    <div style="margin-top:8px">
      <button class="btn" onclick="requestOtp()">OTP मागवा</button>
      <input id="otpInput" placeholder="मोबाईलवर आलेला OTP" style="width:140px;margin-left:8px"/>
      <button class="btn" onclick="verifyOtp()">OTP तपासा व पार्किंग पूर्ण करा</button>
    </div>
    <div id="payStatus" class="small" style="margin-top:8px"></div>
  </section>

  <section class="card" id="seasonCard" style="display:none;margin-top:12px">
    <h2>सीझन पास (QR)</h2>
    <p class="small">हे QR नेहमी येणाऱ्या ग्राहकाला द्या. स्कॅन केल्यावर फॉर्म ऑटो-फिल होईल.</p>
    <div class="qr" id="seasonQr">QR जनरेट केल्यावर दिसेल</div>
  </section>

  <div class="footer">© <span id="year"></span> रेल्वे स्टेशन पार्किंग</div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
const UPI_ID = '7558459483@ptsbi';
let currentEntry = null;

function startEntry(){
  const v = document.getElementById('vehicleNo').value.trim().toUpperCase();
  const m = document.getElementById('mobile').value.trim();
  const dur = document.getElementById('duration').value;
  const season = document.getElementById('seasonPass').checked;
  if(!v || !/^\d{10}$/.test(m) || !dur){
    alert('सर्व फील्ड भरा');
    return;
  }
  currentEntry = {vehicleNo:v, mobile:m, durationHours: Number(dur), season: season};
  document.getElementById('paymentCard').style.display = 'block';
  if(season){
    // request server to create season QR
    fetch('/api/season', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({vehicleNo:v,mobile:m})})
      .then(r=>r.json()).then(j=>{
        if(j.ok){
          const el = document.getElementById('seasonQr');
          el.innerHTML='';
          new QRCode(el, {text: j.qrUrl, width:180, height:180});
          document.getElementById('seasonCard').style.display='block';
        }
      }).catch(console.error);
  }else{
    document.getElementById('seasonCard').style.display='none';
  }
}

function calc(){
  const vt = document.getElementById('vehicleType').value;
  const amt = vt === '2w' ? 20 : vt === '4w' ? 50 : 0;
  document.getElementById('amount').value = amt ? '₹'+amt : '';
  // generate UPI QR
  const note = encodeURIComponent('Railway Parking');
  const url = `upi://pay?pa=${encodeURIComponent(UPI_ID)}&pn=Railway%20Parking&am=${amt}&cu=INR&tn=${note}`;
  document.getElementById('qrcode').innerHTML='';
  if(amt) new QRCode(document.getElementById('qrcode'), {text:url,width:220,height:220});
}

async function requestOtp(){
  if(!currentEntry) return alert('प्रथम प्रवेश माहिती भरा');
  const res = await fetch('/api/request-otp', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({mobile: currentEntry.mobile})});
  const j = await res.json();
  document.getElementById('payStatus').textContent = j.ok ? 'OTP पाठविला गेला आहे' : ('त्रुटी: '+j.error);
}

async function verifyOtp(){
  const otp = document.getElementById('otpInput').value.trim();
  if(!otp) return alert('OTP टाका');
  const vt = document.getElementById('vehicleType').value;
  const amount = document.getElementById('amount').value.replace('₹','') || 0;
  if(!vt || !amount) return alert('वाहन प्रकार व रक्कम निवडा');
  const body = {...currentEntry, vehicleType: vt, amount: Number(amount), otp};
  const res = await fetch('/api/verify-otp', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
  const j = await res.json();
  if(j.ok){
    document.getElementById('payStatus').textContent = 'पार्किंग नोंद झाली; SMS/WhatsApp पाठवण्यात आले आहेत.';
    // show receipt maybe
  }else{
    document.getElementById('payStatus').textContent = 'त्रुटी: '+j.error;
  }
}

document.getElementById('year').textContent = new Date().getFullYear();
</script>
</body>
</html>
